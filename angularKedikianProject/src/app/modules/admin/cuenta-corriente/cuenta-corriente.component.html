<div class="cuenta-corriente-container">
  <header class="cuenta-corriente-header">
    <h1>
      <i class="fas fa-file-invoice-dollar"></i>
      Cuenta Corriente / Final de Obra
    </h1>
    <div class="header-buttons" *ngIf="esAdministrador">
      <button
        class="btn btn-warning"
        *ngIf="haySeleccion()"
        (click)="limpiarSelecciones()"
        title="Limpiar selección">
        <i class="fas fa-times-circle"></i>
        Limpiar Selección
      </button>
      <button
        class="btn btn-primary"
        (click)="abrirModalGenerarReporte()"
        [disabled]="!proyectoSeleccionado || !resumen || !haySeleccion()">
        <i class="fas fa-plus"></i>
        Generar Reporte con Selección
        <span *ngIf="haySeleccion()" class="badge-count-header">
          {{ aridosSeleccionados.size + horasSeleccionadas.size }}
        </span>
      </button>
    </div>
  </header>

  <!-- Selector de Proyecto y Período -->
  <div class="controles-principales">
    <div class="control-grupo">
      <label for="proyectoSelect">
        <i class="fas fa-project-diagram"></i>
        Proyecto:
      </label>
      <select
        id="proyectoSelect"
        [(ngModel)]="proyectoSeleccionado"
        (ngModelChange)="onProyectoChange()"
        class="form-control">
        <option [value]="null" disabled>Seleccione un proyecto</option>
        <option *ngFor="let proyecto of proyectos" [value]="proyecto.id">
          {{ proyecto.nombre }}
        </option>
      </select>
    </div>

    <div class="control-grupo">
      <label>
        <i class="fas fa-calendar-alt"></i>
        Período:
      </label>
      <div class="periodo-buttons">
        <button
          class="btn"
          [class.btn-active]="periodoActual === 'semana'"
          (click)="cambiarPeriodo('semana')">
          Semana Actual
        </button>
        <button
          class="btn"
          [class.btn-active]="periodoActual === 'mes'"
          (click)="cambiarPeriodo('mes')">
          Mes Actual
        </button>
        <button
          class="btn"
          [class.btn-active]="periodoActual === 'anual'"
          (click)="cambiarPeriodo('anual')">
          Año Actual
        </button>
        <button
          class="btn"
          [class.btn-active]="periodoActual === 'personalizado'"
          (click)="cambiarPeriodo('personalizado')">
          Personalizado
        </button>
      </div>
    </div>

    <div class="control-grupo" *ngIf="periodoActual === 'personalizado'">
      <label for="fechaInicio">Desde:</label>
      <input
        type="date"
        id="fechaInicio"
        [(ngModel)]="fechaInicio"
        (ngModelChange)="onFechaChange()"
        class="form-control">
    </div>

    <div class="control-grupo" *ngIf="periodoActual === 'personalizado'">
      <label for="fechaFin">Hasta:</label>
      <input
        type="date"
        id="fechaFin"
        [(ngModel)]="fechaFin"
        (ngModelChange)="onFechaChange()"
        class="form-control">
    </div>
  </div>

  <!-- Loader -->
  <div *ngIf="cargandoResumen" class="loader-container">
    <div class="loader"></div>
    <p>Cargando información...</p>
  </div>

  <!-- Resumen y Tablas -->
  <div *ngIf="!cargandoResumen && resumen" class="resumen-container">

    <!-- Cards de Totales -->
    <div class="totales-cards">
      <div class="card-total card-aridos">
        <div class="card-icon">
          <i class="fas fa-cubes"></i>
        </div>
        <div class="card-info">
          <h3>Total Áridos</h3>
          <p class="cantidad">{{ resumen.total_aridos_m3 | number:'1.2-2' }} m³</p>
          <p class="monto">{{ formatearMoneda(resumen.total_importe_aridos) }}</p>
        </div>
      </div>

      <div class="card-total card-horas">
        <div class="card-icon">
          <i class="fas fa-clock"></i>
        </div>
        <div class="card-info">
          <h3>Total Horas Máquinas</h3>
          <p class="cantidad">{{ resumen.total_horas | number:'1.2-2' }} hs</p>
          <p class="monto">{{ formatearMoneda(resumen.total_importe_horas) }}</p>
        </div>
      </div>

      <div class="card-total card-total-general">
        <div class="card-icon">
          <i class="fas fa-dollar-sign"></i>
        </div>
        <div class="card-info">
          <h3>Total General</h3>
          <p class="monto-grande">{{ formatearMoneda(resumen.importe_total) }}</p>
          <p class="periodo-info">
            {{ formatearFechaLegible(resumen.periodo_inicio) }} -
            {{ formatearFechaLegible(resumen.periodo_fin) }}
          </p>
        </div>
      </div>
    </div>

    <!-- Cards de Selección (solo si hay items seleccionados) -->
    <div class="totales-cards totales-seleccion" *ngIf="haySeleccion()">
      <div class="card-total card-seleccion card-aridos-seleccion">
        <div class="card-icon">
          <i class="fas fa-check-square"></i>
        </div>
        <div class="card-info">
          <h3>Áridos Seleccionados</h3>
          <p class="cantidad">{{ getTotalAridosSeleccionados() | number:'1.2-2' }} m³</p>
          <p class="monto">{{ formatearMoneda(getTotalImporteAridosSeleccionados()) }}</p>
          <p class="items-count">{{ aridosSeleccionados.size }} tipo(s)</p>
        </div>
      </div>

      <div class="card-total card-seleccion card-horas-seleccion">
        <div class="card-icon">
          <i class="fas fa-check-square"></i>
        </div>
        <div class="card-info">
          <h3>Horas Seleccionadas</h3>
          <p class="cantidad">{{ getTotalHorasSeleccionadas() | number:'1.2-2' }} hs</p>
          <p class="monto">{{ formatearMoneda(getTotalImporteHorasSeleccionadas()) }}</p>
          <p class="items-count">{{ horasSeleccionadas.size }} máquina(s)</p>
        </div>
      </div>

      <div class="card-total card-seleccion card-total-seleccion">
        <div class="card-icon">
          <i class="fas fa-file-invoice"></i>
        </div>
        <div class="card-info">
          <h3>Total Seleccionado</h3>
          <p class="monto-grande">{{ formatearMoneda(getTotalGeneralSeleccionado()) }}</p>
          <p class="periodo-info">
            Para nuevo reporte
          </p>
        </div>
      </div>
    </div>

    <!-- Tabla de Áridos -->
    <div class="tabla-section">
      <h2>
        <i class="fas fa-cubes"></i>
        Áridos Entregados
      </h2>

      <div *ngIf="resumen.aridos.length === 0" class="no-datos">
        No hay registros de áridos en este período.
      </div>

      <table *ngIf="resumen.aridos.length > 0" class="tabla-datos">
        <thead>
          <tr>
            <th style="width: 50px;">
              <label class="checkbox-container">
                <input
                  type="checkbox"
                  [checked]="todosAridosSeleccionados()"
                  (change)="toggleSeleccionarTodosAridos()"
                  title="Seleccionar todos">
                <span class="checkmark"></span>
              </label>
            </th>
            <th>Tipo de Árido</th>
            <th>Cantidad (m³)</th>
            <th>Precio Unitario</th>
            <th>Importe</th>
            <th *ngIf="esAdministrador">Acciones</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let arido of resumen.aridos"
              [class.editando]="editandoArido === arido.tipo_arido"
              [class.fila-seleccionada]="isAridoSeleccionado(arido.tipo_arido)">
            <td class="td-checkbox">
              <label class="checkbox-container">
                <input
                  type="checkbox"
                  [checked]="isAridoSeleccionado(arido.tipo_arido)"
                  (change)="toggleAridoSeleccionado(arido.tipo_arido)">
                <span class="checkmark"></span>
              </label>
            </td>
            <td>
              <span>{{ arido.tipo_arido }}</span>
            </td>
            <td>
              <span>{{ arido.cantidad | number:'1.2-2' }}</span>
            </td>
            <td>
              <span *ngIf="editandoArido !== arido.tipo_arido">{{ formatearMoneda(arido.precio_unitario) }}</span>
              <input
                *ngIf="editandoArido === arido.tipo_arido"
                type="number"
                [(ngModel)]="arido.precio_unitario"
                (ngModelChange)="recalcularImporteArido(arido)"
                class="form-control-inline"
                step="0.01"
                min="0">
            </td>
            <td class="subtotal">{{ formatearMoneda(arido.importe) }}</td>
            <td *ngIf="esAdministrador">
              <div class="acciones-cell">
                <button
                  *ngIf="editandoArido !== arido.tipo_arido"
                  class="btn-icon btn-edit"
                  (click)="iniciarEdicionArido(arido)"
                  title="Editar">
                  <i class="fas fa-edit"></i>
                </button>
                <button
                  *ngIf="editandoArido === arido.tipo_arido"
                  class="btn-icon btn-save"
                  (click)="guardarEdicionArido(arido)"
                  title="Guardar">
                  <i class="fas fa-check"></i>
                </button>
                <button
                  *ngIf="editandoArido === arido.tipo_arido"
                  class="btn-icon btn-cancel"
                  (click)="cancelarEdicionArido()"
                  title="Cancelar">
                  <i class="fas fa-times"></i>
                </button>
              </div>
            </td>
          </tr>
        </tbody>
        <tfoot>
          <tr class="total-row">
            <td></td>
            <td><strong>TOTAL ÁRIDOS</strong></td>
            <td><strong>{{ resumen.total_aridos_m3 | number:'1.2-2' }} m³</strong></td>
            <td></td>
            <td class="subtotal"><strong>{{ formatearMoneda(resumen.total_importe_aridos) }}</strong></td>
            <td *ngIf="esAdministrador"></td>
          </tr>
          <tr class="seleccion-row" *ngIf="aridosSeleccionados.size > 0">
            <td></td>
            <td><strong>SELECCIONADO ({{ aridosSeleccionados.size }})</strong></td>
            <td><strong>{{ getTotalAridosSeleccionados() | number:'1.2-2' }} m³</strong></td>
            <td></td>
            <td class="subtotal"><strong>{{ formatearMoneda(getTotalImporteAridosSeleccionados()) }}</strong></td>
            <td *ngIf="esAdministrador"></td>
          </tr>
        </tfoot>
      </table>
    </div>

    <!-- Tabla de Horas de Máquinas -->
    <div class="tabla-section">
      <h2>
        <i class="fas fa-truck"></i>
        Horas de Máquinas
      </h2>

      <div *ngIf="resumen.horas_maquinas.length === 0" class="no-datos">
        No hay registros de horas de máquinas en este período.
      </div>

      <table *ngIf="resumen.horas_maquinas.length > 0" class="tabla-datos">
        <thead>
          <tr>
            <th style="width: 50px;">
              <label class="checkbox-container">
                <input
                  type="checkbox"
                  [checked]="todasHorasSeleccionadas()"
                  (change)="toggleSeleccionarTodasHoras()"
                  title="Seleccionar todas">
                <span class="checkmark"></span>
              </label>
            </th>
            <th>Máquina</th>
            <th>Total Horas</th>
            <th>Tarifa/Hora</th>
            <th>Importe</th>
            <th *ngIf="esAdministrador">Acciones</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let hora of resumen.horas_maquinas"
              [class.editando]="editandoHora === hora.maquina_id"
              [class.fila-seleccionada]="isHoraSeleccionada(hora.maquina_id)">
            <td class="td-checkbox">
              <label class="checkbox-container">
                <input
                  type="checkbox"
                  [checked]="isHoraSeleccionada(hora.maquina_id)"
                  (change)="toggleHoraSeleccionada(hora.maquina_id)">
                <span class="checkmark"></span>
              </label>
            </td>
            <td>{{ hora.maquina_nombre }}</td>
            <td>
              <span>{{ hora.total_horas | number:'1.2-2' }}</span>
            </td>
            <td>
              <span *ngIf="editandoHora !== hora.maquina_id">{{ formatearMoneda(hora.tarifa_hora) }}</span>
              <input
                *ngIf="editandoHora === hora.maquina_id"
                type="number"
                [(ngModel)]="hora.tarifa_hora"
                (ngModelChange)="recalcularImporteMaquina(hora)"
                class="form-control-inline"
                step="0.01"
                min="0">
            </td>
            <td class="subtotal">{{ formatearMoneda(hora.importe) }}</td>
            <td *ngIf="esAdministrador">
              <div class="acciones-cell">
                <button
                  *ngIf="editandoHora !== hora.maquina_id"
                  class="btn-icon btn-edit"
                  (click)="iniciarEdicionHora(hora)"
                  title="Editar">
                  <i class="fas fa-edit"></i>
                </button>
                <button
                  *ngIf="editandoHora === hora.maquina_id"
                  class="btn-icon btn-save"
                  (click)="guardarEdicionHora(hora)"
                  title="Guardar">
                  <i class="fas fa-check"></i>
                </button>
                <button
                  *ngIf="editandoHora === hora.maquina_id"
                  class="btn-icon btn-cancel"
                  (click)="cancelarEdicionHora()"
                  title="Cancelar">
                  <i class="fas fa-times"></i>
                </button>
              </div>
            </td>
          </tr>
        </tbody>
        <tfoot>
          <tr class="total-row">
            <td></td>
            <td><strong>TOTAL HORAS</strong></td>
            <td><strong>{{ resumen.total_horas | number:'1.2-2' }} hs</strong></td>
            <td></td>
            <td class="subtotal"><strong>{{ formatearMoneda(resumen.total_importe_horas) }}</strong></td>
            <td *ngIf="esAdministrador"></td>
          </tr>
          <tr class="seleccion-row" *ngIf="horasSeleccionadas.size > 0">
            <td></td>
            <td><strong>SELECCIONADO ({{ horasSeleccionadas.size }})</strong></td>
            <td><strong>{{ getTotalHorasSeleccionadas() | number:'1.2-2' }} hs</strong></td>
            <td></td>
            <td class="subtotal"><strong>{{ formatearMoneda(getTotalImporteHorasSeleccionadas()) }}</strong></td>
            <td *ngIf="esAdministrador"></td>
          </tr>
        </tfoot>
      </table>
    </div>
  </div>

  <!-- Sección de Reportes Generados -->
  <div class="reportes-section" *ngIf="!cargandoReportes">
    <h2>
      <i class="fas fa-file-alt"></i>
      Reportes Generados
    </h2>

    <div *ngIf="reportes.length === 0" class="no-datos">
      No hay reportes generados para este proyecto.
    </div>

    <div *ngIf="reportes.length > 0" class="reportes-lista">
      <div *ngFor="let reporte of reportes" class="reporte-item" [class.expandido]="isReporteExpandido(reporte.id)">
        <div class="reporte-resumen" (click)="toggleReporte(reporte.id)">
          <div class="reporte-info-principal">
            <div class="reporte-titulo">
              <h3>Reporte #{{ reporte.id }}</h3>
              <span class="badge" [ngClass]="getEstadoBadgeClass(reporte.estado)">
                {{ getEstadoTexto(reporte.estado) }}
              </span>
            </div>
            <div class="reporte-datos-breves">
              <span class="dato-breve">
                <i class="fas fa-calendar"></i>
                {{ formatearFechaLegible(reporte.periodo_inicio) }} - {{ formatearFechaLegible(reporte.periodo_fin) }}
              </span>
              <span class="dato-breve importe">
                <i class="fas fa-dollar-sign"></i>
                {{ formatearMoneda(reporte.importe_total) }}
              </span>
            </div>
          </div>
          <div class="toggle-icon">
            <i class="fas" [ngClass]="isReporteExpandido(reporte.id) ? 'fa-chevron-up' : 'fa-chevron-down'"></i>
          </div>
        </div>

        <div class="reporte-detalle" *ngIf="isReporteExpandido(reporte.id)">
          <div class="detalle-info-general">
            <div class="info-item">
              <i class="fas fa-clock"></i>
              <strong>Generado:</strong>
              <span>{{ formatearFechaLegible(reporte.fecha_generacion) }}</span>
            </div>
            <div class="info-item" *ngIf="reporte.observaciones">
              <i class="fas fa-comment"></i>
              <strong>Observaciones:</strong>
              <span class="observaciones-texto">{{ reporte.observaciones }}</span>
            </div>
          </div>

          <!-- Desglose de Áridos -->
          <div class="items-section">
            <h4>
              <i class="fas fa-cubes"></i>
              Desglose de Áridos
              <span class="badge-count" *ngIf="getReporteConDetalle(reporte.id)?.items_aridos">
                ({{ getReporteConDetalle(reporte.id)!.items_aridos!.length }} entregas)
              </span>
            </h4>

            <div *ngIf="!getReporteConDetalle(reporte.id)?.items_aridos || getReporteConDetalle(reporte.id)!.items_aridos!.length === 0" class="no-items">
              <i class="fas fa-info-circle"></i>
              No hay entregas de áridos registradas en este período.
            </div>

            <table class="tabla-items" *ngIf="getReporteConDetalle(reporte.id)?.items_aridos && getReporteConDetalle(reporte.id)!.items_aridos!.length > 0">
              <thead>
                <tr>
                  <th>Tipo de Árido</th>
                  <th>Fecha</th>
                  <th>Cantidad</th>
                  <th>Precio Unitario</th>
                  <th>Importe</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let item of getReporteConDetalle(reporte.id)!.items_aridos" [class.fila-pagada]="item.pagado">
                  <td>
                    <strong>{{ item.tipo_arido }}</strong>
                  </td>
                  <td>
                    <span class="fecha-item">{{ item.fecha ? (item.fecha | date:'dd/MM/yyyy') : '-' }}</span>
                  </td>
                  <td>
                    {{ item.cantidad | number:'1.2-2' }} m³
                  </td>
                  <td>
                    {{ formatearMoneda(item.precio_unitario) }}/m³
                  </td>
                  <td class="td-importe">
                    <strong>{{ formatearMoneda(item.importe) }}</strong>
                    <i class="fas fa-check-circle icon-pagado" *ngIf="item.pagado"></i>
                  </td>
                </tr>
              </tbody>
              <tfoot>
                <tr class="total-row">
                  <td colspan="4"><strong>SUBTOTAL ÁRIDOS:</strong></td>
                  <td class="td-importe"><strong>{{ formatearMoneda(reporte.importe_aridos) }}</strong></td>
                </tr>
              </tfoot>
            </table>
          </div>

          <!-- Desglose de Horas de Máquinas -->
          <div class="items-section">
            <h4>
              <i class="fas fa-truck"></i>
              Desglose de Horas de Máquinas
              <span class="badge-count" *ngIf="getReporteConDetalle(reporte.id)?.items_horas">
                ({{ getReporteConDetalle(reporte.id)!.items_horas!.length }} reportes)
              </span>
            </h4>

            <div *ngIf="!getReporteConDetalle(reporte.id)?.items_horas || getReporteConDetalle(reporte.id)!.items_horas!.length === 0" class="no-items">
              <i class="fas fa-info-circle"></i>
              No hay reportes de horas de máquinas en este período.
            </div>

            <table class="tabla-items" *ngIf="getReporteConDetalle(reporte.id)?.items_horas && getReporteConDetalle(reporte.id)!.items_horas!.length > 0">
              <thead>
                <tr>
                  <th>Máquina</th>
                  <th>Fecha</th>
                  <th>Horas</th>
                  <th>Tarifa/Hora</th>
                  <th>Importe</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let item of getReporteConDetalle(reporte.id)!.items_horas" [class.fila-pagada]="item.pagado">
                  <td>
                    <strong>{{ item.maquina_nombre }}</strong>
                    <span class="operador-info" *ngIf="item.usuario_nombre">
                      <i class="fas fa-user"></i> {{ item.usuario_nombre }}
                    </span>
                  </td>
                  <td>
                    <span class="fecha-item">{{ item.fecha ? (item.fecha | date:'dd/MM/yyyy') : '-' }}</span>
                  </td>
                  <td>
                    {{ item.total_horas | number:'1.2-2' }} hs
                  </td>
                  <td>
                    {{ formatearMoneda(item.tarifa_hora) }}/h
                  </td>
                  <td class="td-importe">
                    <strong>{{ formatearMoneda(item.importe) }}</strong>
                    <i class="fas fa-check-circle icon-pagado" *ngIf="item.pagado"></i>
                  </td>
                </tr>
              </tbody>
              <tfoot>
                <tr class="total-row">
                  <td colspan="4"><strong>SUBTOTAL HORAS:</strong></td>
                  <td class="td-importe"><strong>{{ formatearMoneda(reporte.importe_horas) }}</strong></td>
                </tr>
              </tfoot>
            </table>
          </div>

          <!-- Resumen de totales -->
          <div class="detalle-totales">
            <div class="total-linea">
              <span>Total Áridos:</span>
              <strong>{{ formatearMoneda(reporte.importe_aridos) }}</strong>
            </div>
            <div class="total-linea">
              <span>Total Horas:</span>
              <strong>{{ formatearMoneda(reporte.importe_horas) }}</strong>
            </div>
            <div class="total-linea total-general">
              <span>Total General:</span>
              <strong>{{ formatearMoneda(reporte.importe_total) }}</strong>
            </div>
          </div>

          <div class="detalle-acciones">
            <div class="acciones-izquierda">
              <button
                class="btn btn-sm btn-outline"
                (click)="abrirModalExportar(reporte.id); $event.stopPropagation()">
                <i class="fas fa-download"></i>
                Exportar
              </button>
            </div>

            <div class="estado-buttons" *ngIf="esAdministrador">
              <button
                class="btn btn-sm btn-success"
                (click)="marcarTodosItemsPagados(reporte.id); $event.stopPropagation()"
                title="Marcar todos como pagados">
                <i class="fas fa-check-double"></i>
                Marcar Todo Pagado
              </button>
              <button
                class="btn btn-sm btn-warning"
                (click)="marcarTodosItemsPendientes(reporte.id); $event.stopPropagation()"
                title="Marcar todos como pendientes">
                <i class="fas fa-undo"></i>
                Marcar Todo Pendiente
              </button>
              <button
                class="btn btn-sm btn-danger"
                (click)="eliminarReporte(reporte.id); $event.stopPropagation()"
                title="Eliminar reporte">
                <i class="fas fa-trash"></i>
                Eliminar
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal: Generar Reporte -->
<div class="modal-overlay" *ngIf="mostrarModalGenerarReporte" (click)="cerrarModalGenerarReporte()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>Generar Nuevo Reporte</h2>
      <button class="btn-close" (click)="cerrarModalGenerarReporte()">
        <i class="fas fa-times"></i>
      </button>
    </div>

    <form [formGroup]="reporteForm" (ngSubmit)="generarReporte()">
      <div class="modal-body">
        <!-- Resumen de selección -->
        <div class="resumen-seleccion-modal">
          <h4>
            <i class="fas fa-check-circle"></i>
            Items seleccionados para el reporte
          </h4>
          <div class="items-seleccionados-grid">
            <div class="item-seleccion-info">
              <i class="fas fa-cubes"></i>
              <div>
                <strong>{{ aridosSeleccionados.size }}</strong> tipo(s) de áridos
                <span class="cantidad-detalle">{{ getTotalAridosSeleccionados() | number:'1.2-2' }} m³</span>
              </div>
            </div>
            <div class="item-seleccion-info">
              <i class="fas fa-truck"></i>
              <div>
                <strong>{{ horasSeleccionadas.size }}</strong> máquina(s)
                <span class="cantidad-detalle">{{ getTotalHorasSeleccionadas() | number:'1.2-2' }} hs</span>
              </div>
            </div>
          </div>
          <div class="total-seleccion-modal">
            <span>Total a facturar:</span>
            <strong>{{ formatearMoneda(getTotalGeneralSeleccionado()) }}</strong>
          </div>
        </div>

        <div class="form-group">
          <label for="periodo_inicio">Fecha Inicio:</label>
          <input
            type="date"
            id="periodo_inicio"
            formControlName="periodo_inicio"
            class="form-control"
            required>
        </div>

        <div class="form-group">
          <label for="periodo_fin">Fecha Fin:</label>
          <input
            type="date"
            id="periodo_fin"
            formControlName="periodo_fin"
            class="form-control"
            required>
        </div>

        <div class="form-group">
          <label for="observaciones">Observaciones (opcional):</label>
          <textarea
            id="observaciones"
            formControlName="observaciones"
            class="form-control"
            rows="3"
            placeholder="Agregue notas o comentarios sobre este reporte..."></textarea>
        </div>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="cerrarModalGenerarReporte()">
          Cancelar
        </button>
        <button type="submit" class="btn btn-primary" [disabled]="reporteForm.invalid">
          <i class="fas fa-check"></i>
          Generar Reporte
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Modal: Exportar -->
<div class="modal-overlay" *ngIf="mostrarModalExportar" (click)="cerrarModalExportar()">
  <div class="modal-content modal-small" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>Exportar Reporte</h2>
      <button class="btn-close" (click)="cerrarModalExportar()">
        <i class="fas fa-times"></i>
      </button>
    </div>

    <div class="modal-body">
      <p>Seleccione el formato de exportación:</p>
      <div class="export-buttons">
        <button
          class="btn btn-danger btn-lg"
          (click)="exportarPDF(reporteSeleccionadoExportar!)">
          <i class="fas fa-file-pdf"></i>
          Exportar PDF
        </button>
        <button
          class="btn btn-success btn-lg"
          (click)="exportarExcel(reporteSeleccionadoExportar!)">
          <i class="fas fa-file-excel"></i>
          Exportar Excel
        </button>
      </div>
    </div>

    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="cerrarModalExportar()">
        Cerrar
      </button>
    </div>
  </div>
</div>

<!-- Modal de Confirmación de Cambios -->
<div class="modal-overlay" *ngIf="mostrarModalConfirmacion" (click)="cancelarActualizacion()">
  <div class="modal-content modal-confirmacion" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>
        <i class="fas fa-exclamation-triangle"></i>
        Confirmar Actualización
      </h2>
      <button class="btn-close" (click)="cancelarActualizacion()">
        <i class="fas fa-times"></i>
      </button>
    </div>

    <div class="modal-body" *ngIf="confirmacionData">
      <div class="confirmacion-alerta">
        <i class="fas fa-info-circle"></i>
        <p>
          Está a punto de actualizar el <strong>{{ confirmacionData.tipo === 'árido' ? 'precio unitario' : 'tarifa por hora' }}</strong>
          de <strong>{{ confirmacionData.descripcion }}</strong>.
        </p>
      </div>

      <div class="confirmacion-detalle">
        <div class="detalle-row">
          <span class="label">{{ confirmacionData.tipo === 'árido' ? 'Precio anterior:' : 'Tarifa anterior:' }}</span>
          <span class="valor">{{ formatearMoneda(confirmacionData.valorAnterior) }}</span>
        </div>
        <div class="detalle-row destacado">
          <span class="label">{{ confirmacionData.tipo === 'árido' ? 'Precio nuevo:' : 'Tarifa nueva:' }}</span>
          <span class="valor">{{ formatearMoneda(confirmacionData.valorNuevo) }}</span>
        </div>
        <div class="detalle-row">
          <span class="label">Período:</span>
          <span class="valor">
            {{ formatearFechaLegible(confirmacionData.fechaInicio) }} -
            {{ formatearFechaLegible(confirmacionData.fechaFin) }}
          </span>
        </div>
      </div>

      <div class="confirmacion-impacto">
        <h4>
          <i class="fas fa-calculator"></i>
          Impacto en el resumen
        </h4>
        <div class="impacto-info">
          <div class="impacto-item">
            <i class="fas fa-arrow-right"></i>
            <span>Se actualizarán todos los registros de este {{ confirmacionData.tipo }} en el período seleccionado.</span>
          </div>
          <div class="impacto-item">
            <i class="fas fa-redo"></i>
            <span>Los totales se recalcularán automáticamente.</span>
          </div>
        </div>
      </div>

      <div class="confirmacion-pregunta">
        <i class="fas fa-question-circle"></i>
        <strong>¿Desea continuar con esta actualización?</strong>
      </div>
    </div>

    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="cancelarActualizacion()">
        <i class="fas fa-times"></i>
        Cancelar
      </button>
      <button class="btn btn-primary" (click)="confirmarActualizacion()">
        <i class="fas fa-check"></i>
        Confirmar Actualización
      </button>
    </div>
  </div>
</div>
