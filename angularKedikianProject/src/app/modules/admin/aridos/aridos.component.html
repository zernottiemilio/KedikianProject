<div class="aridos-container">
  <header class="aridos-header">
    <h1>Gestión de Áridos</h1>
    <div class="header-buttons">
      <button class="btn btn-info" (click)="toggleFiltros()">
        <i class="fas fa-filter"></i>
        {{ mostrarFiltros ? 'Ocultar Filtros' : 'Mostrar Filtros' }}
      </button>
      <button class="btn btn-success" (click)="abrirModalAgregar()">
        <i class="fas fa-plus"></i>
        Nuevo Registro
      </button>
    </div>
  </header>

  <!-- Navegación de Mes -->
  <div class="navegacion-mes">
    <button class="btn-flecha" (click)="mesAnterior()" title="Mes anterior">
      <i class="fas fa-chevron-left"></i>
    </button>
    <div class="mes-actual">
      <i class="fas fa-calendar-alt"></i>
      {{ obtenerNombreMes() }}
    </div>
    <button class="btn-flecha" (click)="mesSiguiente()" title="Mes siguiente">
      <i class="fas fa-chevron-right"></i>
    </button>
  </div>

  <!-- Panel de Filtros -->
  <div class="filtros-panel" *ngIf="mostrarFiltros">
    <h3>
      <i class="fas fa-filter"></i>
      Filtros
    </h3>
    <div class="filtros-grid">
      <div class="filtro-item">
        <label for="filtroProyecto">Proyecto:</label>
        <select 
          id="filtroProyecto" 
          [(ngModel)]="filtroProyecto" 
          (ngModelChange)="aplicarFiltros()"
          class="form-control">
          <option value="">Todos los proyectos</option>
          <option *ngFor="let proyecto of proyectos" [value]="proyecto.id">
            {{ proyecto.nombre }}
          </option>
        </select>
      </div>

      <div class="filtro-item">
        <label for="filtroArido">Tipo de Árido:</label>
        <select 
          id="filtroArido" 
          [(ngModel)]="filtroArido" 
          (ngModelChange)="aplicarFiltros()"
          class="form-control">
          <option value="">Todos los áridos</option>
          <option *ngFor="let arido of aridos" [value]="arido.id">
            {{ arido.nombre }}
          </option>
        </select>
      </div>

      <div class="filtro-item">
        <label for="filtroOperario">Operario:</label>
        <input 
          type="text" 
          id="filtroOperario" 
          [(ngModel)]="filtroOperario" 
          (ngModelChange)="aplicarFiltros()"
          placeholder="Buscar por nombre..."
          class="form-control">
      </div>

      <div class="filtro-item">
        <label for="filtroFechaDesde">Fecha Desde:</label>
        <input 
          type="date" 
          id="filtroFechaDesde" 
          [(ngModel)]="filtroFechaDesde" 
          (ngModelChange)="aplicarFiltros()"
          class="form-control">
      </div>

      <div class="filtro-item">
        <label for="filtroFechaHasta">Fecha Hasta:</label>
        <input
          type="date"
          id="filtroFechaHasta"
          [(ngModel)]="filtroFechaHasta"
          (ngModelChange)="aplicarFiltros()"
          class="form-control">
      </div>

      <div class="filtro-item filtro-acciones">
        <button 
          class="btn btn-secondary" 
          (click)="limpiarFiltros()"
          [disabled]="!hayFiltrosActivos()">
          <i class="fas fa-times"></i>
          Limpiar Filtros
        </button>
      </div>
    </div>
    
    <div class="filtros-info" *ngIf="hayFiltrosActivos()">
      <i class="fas fa-info-circle"></i>
      Mostrando {{ registrosFiltrados.length }} de {{ registros.length }} registros
    </div>
  </div>

  <!-- Tabla de registros -->
  <div class="registros-tabla-container">
    <h2>Registros de Áridos</h2>
    <div *ngIf="registrosFiltrados.length === 0" class="no-registros">
      {{ hayFiltrosActivos() ? 'No hay registros que coincidan con los filtros seleccionados.' : 'No hay registros disponibles.' }}
    </div>

    <table *ngIf="registrosFiltrados.length > 0" class="tabla-registros">
      <thead>
        <tr>
          <th>Proyecto</th>
          <th>Árido</th>
          <th>Cantidad</th>
          <th>Fecha</th>
          <th>Operario</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody>
        <ng-container *ngFor="let registro of registrosFiltrados; trackBy: trackByRegistroId">
          <tr>
            <td>{{ registro.proyectoNombre }}</td>
            <td>{{ registro.aridoNombre }}</td>
            <td>{{ registro.cantidad | number:'1.2-2' }} {{ getUnidadMedida(registro.aridoId) }}</td>
            <td>{{ registro.fechaEntrega | date:'dd/MM/yyyy' }}</td>
            <td>{{ registro.operario }}</td>
            <td class="acciones">
              <button class="btn-icon btn-edit" title="Editar" (click)="editarRegistro(registro)">
                <i class="fas fa-edit"></i>
              </button>
              <button class="btn-icon btn-delete" title="Eliminar" (click)="confirmarEliminar(registro)">
                <i class="fas fa-trash"></i>
              </button>
            </td>
          </tr>
          <tr *ngIf="registro.observaciones" class="fila-observaciones">
            <td colspan="6">
              <strong>Observaciones:</strong> {{ registro.observaciones }}
            </td>
          </tr>
        </ng-container>
      </tbody>
    </table>
  </div>
</div>

<!-- Modal de Registro/Edición -->
<div class="modal" *ngIf="mostrarModal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>{{ modoEdicion ? 'Editar Registro' : 'Nuevo Registro de Áridos' }}</h2>
      <button class="btn-close" (click)="cerrarModal()">&times;</button>
    </div>
    <div class="modal-body">
      <form [formGroup]="registroForm" (ngSubmit)="agregarRegistro()">
        <div class="form-group">
          <label for="proyectoId">Proyecto:</label>
          <select id="proyectoId" formControlName="proyectoId" class="form-control" required>
            <option value="">Seleccione un proyecto</option>
            <!-- CAMBIO: Usar proyectosActivos en lugar de proyectos -->
            <option *ngFor="let proyecto of proyectosActivos" [value]="proyecto.id">{{ proyecto.nombre }}</option>
          </select>
          <div *ngIf="registroForm.get('proyectoId')?.invalid && registroForm.get('proyectoId')?.touched" class="error-message">
            El proyecto es obligatorio
          </div>
        </div>

        <div class="form-group">
          <label for="aridoId">Tipo de Árido:</label>
          <select id="aridoId" formControlName="aridoId" class="form-control" required>
            <option value="">Seleccione un árido</option>
            <option *ngFor="let arido of aridos" [value]="arido.id">
              {{ arido.nombre }} ({{ arido.unidadMedida }})
            </option>
          </select>
          <div *ngIf="registroForm.get('aridoId')?.invalid && registroForm.get('aridoId')?.touched" class="error-message">
            El tipo de árido es obligatorio
          </div>
        </div>

        <div class="form-group">
          <label for="cantidad">Cantidad:</label>
          <div class="input-group">
            <input type="number" id="cantidad" formControlName="cantidad" class="form-control" step="0.01" min="0.1" required>
            <span class="unidad-medida">
              {{ registroForm.get('aridoId')?.value ? getUnidadMedida(registroForm.get('aridoId')?.value) : '' }}
            </span>
          </div>
          <div *ngIf="registroForm.get('cantidad')?.invalid && registroForm.get('cantidad')?.touched" class="error-message">
            La cantidad es obligatoria y debe ser mayor a 0
          </div>
        </div>

        <div class="form-group">
          <label for="fechaEntrega">Fecha de Entrega:</label>
          <input type="date" id="fechaEntrega" formControlName="fechaEntrega" class="form-control" required>
          <div *ngIf="registroForm.get('fechaEntrega')?.invalid && registroForm.get('fechaEntrega')?.touched" class="error-message">
            La fecha de entrega es obligatoria
          </div>
        </div>

        <div class="form-group">
          <label for="operario">Operario:</label>
          <select id="operario" formControlName="operario" class="form-control" required>
            <option value="">Seleccione un operario</option>
            <option *ngFor="let operario of operarios" [value]="operario.id">{{ operario.nombre }}</option>
          </select>
          <div *ngIf="registroForm.get('operario')?.invalid && registroForm.get('operario')?.touched" class="error-message">
            El operario es obligatorio
          </div>
        </div>

        <div class="form-group">
          <label for="observaciones">Observaciones:</label>
          <textarea id="observaciones" formControlName="observaciones" class="form-control" rows="3"></textarea>
        </div>

        <div class="form-buttons">
          <button type="button" class="btn btn-secondary" (click)="cerrarModal()">Cancelar</button>
          <button type="submit" class="btn btn-success" [disabled]="registroForm.invalid">
            {{ modoEdicion ? 'Actualizar' : 'Registrar' }}
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal de Confirmación de Eliminación -->
<div class="modal" *ngIf="mostrarModalConfirmacion">
  <div class="modal-content modal-confirmacion">
    <div class="modal-header">
      <h2>Confirmar Eliminación</h2>
      <button class="btn-close" (click)="cancelarEliminar()">&times;</button>
    </div>
    <div class="modal-body">
      <p>¿Está seguro que desea eliminar este registro?</p>
      <p>Esta acción no se puede deshacer.</p>
      <div class="form-buttons">
        <button type="button" class="btn btn-secondary" (click)="cancelarEliminar()">Cancelar</button>
        <button type="button" class="btn btn-danger" (click)="eliminarRegistro()">Eliminar</button>
      </div>
    </div>
  </div>
</div>