<div class="container">
  <h2>Gesti칩n de Usuarios</h2>

  <div class="actions-bar">
    <button class="btn btn-primary" (click)="openAddUserModal()">
      <i class="fas fa-plus"></i> Nuevo Usuario
    </button>
    <div class="filter-controls">
      <div class="search-box">
        <input type="text" placeholder="B칰squeda r치pida..." [(ngModel)]="searchTerm" (input)="applyFilters()">
        <i class="fas fa-search"></i>
      </div>
      <div class="advanced-filters">
        <div class="filter-row">
          <div class="filter-item">
            <label for="filter-id">ID</label>
            <input type="text" class="form-control form-control-sm" id="filter-id" [(ngModel)]="filters.id"
              (input)="applyFilters()">
          </div>
          <div class="filter-item">
            <label for="filter-nombre">Nombre</label>
            <input type="text" class="form-control form-control-sm" id="filter-nombre" [(ngModel)]="filters.nombre"
              (input)="applyFilters()">
          </div>
          <div class="filter-item">
            <label for="filter-email">Email</label>
            <input type="text" class="form-control form-control-sm" id="filter-email" [(ngModel)]="filters.email"
              (input)="applyFilters()">
          </div>
          <div class="filter-item ml-auto">
            <label for="filter-roles">Rol</label>
            <select class="form-select form-select-sm" id="filter-roles" [(ngModel)]="filters.roles"
              (change)="applyFilters()">
              <option value="">Todos</option>
              <option value="administrador">Administrador</option>
              <option value="operario">Operario</option>
            </select>
          </div>
          <div class="filter-item">
            <label for="filter-estado">Estado</label>
            <select class="form-select form-select-sm" id="filter-estado" [(ngModel)]="filters.estado"
              (change)="applyFilters()">
              <option value="">Todos</option>
              <option [ngValue]="true">Activo</option>
              <option [ngValue]="false">Inactivo</option>
            </select>
          </div>
          <div class="filter-item">
            <button class="btn btn-sm btn-outline-secondary" (click)="clearFilters()">
              <i class="fas fa-times"></i> Limpiar
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="table-responsive">
    <table class="table table-striped">
      <thead>
        <tr>
          <th (click)="sortBy('id')">#ID <i class="fas" [ngClass]="getSortIcon('id')"></i></th>
          <th (click)="sortBy('nombre')">Nombre <i class="fas" [ngClass]="getSortIcon('nombre')"></i></th>
          <th (click)="sortBy('email')">Email <i class="fas" [ngClass]="getSortIcon('email')"></i></th>
          <th (click)="sortBy('roles')">Roles <i class="fas" [ngClass]="getSortIcon('roles')"></i></th>
          <th (click)="sortBy('estado')">Estado <i class="fas" [ngClass]="getSortIcon('estado')"></i></th>
          <th (click)="sortBy('fecha_creacion')">Fecha Creaci칩n <i class="fas"
              [ngClass]="getSortIcon('fecha_creacion')"></i></th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let user of filteredUsers">
          <td>{{ user.id }}</td>
          <td>{{ user.nombre }}</td>
          <td>{{ user.email }}</td>
          <td>{{ getDisplayRole(user.roles[0]) }}</td>
          <td>
            <span class="badge" [ngClass]="user.estado ? 'badge-success' : 'badge-danger'">
              {{ user.estado ? 'Activo' : 'Inactivo' }}
            </span>
          </td>
          <td>{{ user.fecha_creacion | date:'dd/MM/yyyy HH:mm' }}</td>
          <td class="actions">
            <button class="btn btn-sm btn-info" (click)="editUser(user)" title="Editar">
              <i class="fas fa-edit"></i>
            </button>
            <button class="btn btn-sm btn-success" (click)="openJornadaModal(user)" title="Ver Jornadas Laborales">
              <i class="fas fa-clock"></i>
            </button>
            <button class="btn btn-sm btn-danger" (click)="deleteUser(user)" title="Eliminar">
              <i class="fas fa-trash"></i>
            </button>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <div *ngIf="filteredUsers.length === 0" class="no-results">
    <p>No se encontraron usuarios.</p>
  </div>

  <div class="pagination-controls" *ngIf="totalPages > 1">
    <button class="btn btn-sm" [disabled]="currentPage === 1" (click)="goToPage(currentPage - 1)">
      <i class="fas fa-chevron-left"></i>
    </button>
    <span>P치gina {{ currentPage }} de {{ totalPages }}</span>
    <button class="btn btn-sm" [disabled]="currentPage === totalPages" (click)="goToPage(currentPage + 1)">
      <i class="fas fa-chevron-right"></i>
    </button>
  </div>
</div>

<!-- Modal de Edici칩n -->
<div class="modal-overlay" [class.active]="isEditModalOpen">
  <div class="modal-card">
    <div class="modal-header">
      <h2>{{ isEditMode ? 'Editar Usuario' : 'Nuevo Usuario' }}</h2>
      <button class="modal-close" (click)="closeModals()">&times;</button>
    </div>
    <form [formGroup]="userForm" (ngSubmit)="saveUser()">
      <div class="form-group">
        <label for="nombre">Nombre</label>
        <input type="text" id="nombre" formControlName="nombre" class="form-control" placeholder="Ingrese el nombre">
      </div>

      <div class="form-group">
        <label for="email">Email</label>
        <input type="email" id="email" formControlName="email" class="form-control" placeholder="Ingrese el email">
      </div>

      <div class="form-group" *ngIf="!isEditMode">
        <label for="hash_contrasena">Contrase침a</label>
        <input type="password" id="hash_contrasena" formControlName="hash_contrasena" class="form-control" placeholder="Ingrese la contrase침a">
      </div>

      <div class="form-group" *ngIf="isEditMode">
        <div class="checkbox-container">
          <input type="checkbox" id="changePassword" [(ngModel)]="changePassword" [ngModelOptions]="{standalone: true}" (change)="toggleChangePassword()">
          <label for="changePassword">Cambiar contrase침a</label>
        </div>
        <div *ngIf="changePassword" class="password-field-container">
          <input type="password" id="hash_contrasena_edit" formControlName="hash_contrasena" class="form-control" placeholder="Ingrese la nueva contrase침a">
          <small class="form-text text-muted">M칤nimo 8 caracteres</small>
        </div>
      </div>

      <div class="form-group">
        <label for="roles">Rol</label>
        <select id="roles" formControlName="roles" class="form-control">
          <option *ngFor="let role of roleOptions" [value]="role">
            {{role === 'ADMINISTRADOR' ? 'Administrador' : 'Operario'}}
          </option>
        </select>
      </div>

      <div class="form-group">
        <label for="estado">Estado</label>
        <select id="estado" formControlName="estado" class="form-control">
          <option [ngValue]="true">Activo</option>
          <option [ngValue]="false">Inactivo</option>
        </select>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="closeModals()">Cancelar</button>
        <button type="submit" class="btn btn-primary" [disabled]="userForm.invalid">
          {{ isEditMode ? 'Guardar Cambios' : 'Crear Usuario' }}
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Modal de Confirmaci칩n de Eliminaci칩n -->
<div class="modal-overlay" [class.active]="isDeleteModalOpen">
  <div class="modal-card">
    <div class="modal-header">
      <h2>Confirmar Eliminaci칩n</h2>
      <button class="modal-close" (click)="closeModals()">&times;</button>
    </div>
    <p>쮼st치s seguro de que deseas eliminar al usuario "{{ userToDelete?.nombre }}"?</p>
    <div class="modal-footer">
      <button type="button" class="btn btn-secondary" (click)="closeModals()">Cancelar</button>
      <button type="button" class="btn btn-danger" (click)="confirmDelete()">Eliminar</button>
    </div>
  </div>
</div>

<!-- Modal de Jornadas Laborales CON FILTRO MENSUAL -->
<div class="modal-overlay" [class.active]="isJornadaModalOpen">
  <div class="modal-card modal-card-large">
    <div class="modal-header">
      <h2>Jornadas Laborales - {{ selectedUser?.nombre }}</h2>
      <div class="modal-header-actions">
        <button class="btn btn-sm btn-success" (click)="openCreateJornadaModal()" title="Agregar Nueva Jornada">
          <i class="fas fa-plus"></i> Nueva Jornada
        </button>
        <button class="modal-close" (click)="closeModals()">&times;</button>
      </div>
    </div>
    
    <div class="modal-body">
      <!-- 游 SELECTOR DE MES -->
      <div class="month-selector" *ngIf="!loadingJornadas && jornadasLaborales.length > 0">
        <label for="month-filter">
          <i class="fas fa-calendar-alt"></i> Filtrar por mes:
        </label>
        <select 
          id="month-filter" 
          class="form-select" 
          [value]="selectedYear + '-' + selectedMonth"
          (change)="onMonthChange($any($event.target).value)">
          <option 
            *ngFor="let monthData of availableMonths" 
            [value]="monthData.year + '-' + monthData.month">
            {{ monthData.label }}
          </option>
        </select>
      </div>

      <div *ngIf="loadingJornadas" class="loading-container">
        <div class="loading-spinner">
          <i class="fas fa-spinner fa-spin"></i>
        </div>
        <p>Cargando jornadas laborales...</p>
      </div>

      <div *ngIf="!loadingJornadas && jornadasLaborales.length === 0" class="no-results">
        <p>No se encontraron jornadas laborales para este usuario.</p>
      </div>

      <!-- 游 Mostrar mensaje si no hay jornadas en el mes seleccionado -->
      <div *ngIf="!loadingJornadas && jornadasLaborales.length > 0 && jornadasFiltradasPorMes.length === 0" class="no-results">
        <p>No hay jornadas registradas en el mes seleccionado.</p>
      </div>

      <div *ngIf="!loadingJornadas && jornadasFiltradasPorMes.length > 0" class="jornadas-container">
        <!-- 游 RESUMEN DEL MES SELECCIONADO -->
        <div class="jornadas-summary">
          <div class="summary-card">
            <h4>Resumen de {{ getMonthLabel(selectedMonth, selectedYear) }}</h4>
            <div class="summary-stats">
              <div class="stat-item">
                <span class="stat-label">Total Jornadas:</span>
                <span class="stat-value">{{ jornadasFiltradasPorMes.length }}</span>
              </div>
              <div class="stat-item">
                <span class="stat-label">Horas Regulares Total:</span>
                <span class="stat-value">{{ formatHorasDecimales(getTotalHorasRegulares()) }}</span>
              </div>
              <div class="stat-item">
                <span class="stat-label">Horas Extras Total:</span>
                <span class="stat-value">{{ formatHorasDecimales(getTotalHorasExtras()) }}</span>
              </div>
              <div class="stat-item">
                <span class="stat-label">D칤as Feriados:</span>
                <span class="stat-value">{{ getTotalDiasFeriados() }}</span>
              </div>
            </div>
          </div>
        </div>

        <!-- 游 Lista de jornadas filtradas por mes -->
        <div class="jornadas-list">
          <div class="jornada-card" *ngFor="let jornada of jornadasFiltradasPorMes; trackBy: trackByJornadaId">
            
            <!-- MODO VISTA NORMAL -->
            <div *ngIf="!isEditingJornada(jornada.id)">
              <div class="jornada-header">
                <div class="jornada-date">
                  <i class="fas fa-calendar-alt"></i>
                  {{ formatFecha(jornada.fecha) }}
                  <span *ngIf="jornada.es_feriado" class="badge badge-warning holiday-badge">
                    <i class="fas fa-star"></i> Feriado
                  </span>
                </div>
                <div class="jornada-status">
                  <span class="badge" [ngClass]="getEstadoBadgeClass(jornada.estado)">
                    {{ jornada.estado | titlecase }}
                  </span>
                  <button class="btn btn-sm btn-warning ml-2" (click)="editJornada(jornada)" title="Editar Jornada">
                    <i class="fas fa-edit"></i> Editar
                  </button>
                  <button class="btn btn-sm btn-danger ml-2" (click)="openDeleteJornadaModal(jornada)" title="Eliminar Jornada">
                    <i class="fas fa-trash"></i> Eliminar
                  </button>
                </div>
              </div>

              <div class="jornada-details">
                <div class="detail-row">
                  <div class="detail-group">
                    <div class="detail-item">
                      <i class="fas fa-play-circle text-success"></i>
                      <span class="detail-label">Inicio:</span>
                      <span class="detail-value">{{ formatHora(jornada.hora_inicio) }}</span>
                    </div>
                    <div class="detail-item">
                      <i class="fas fa-stop-circle text-danger"></i>
                      <span class="detail-label">Fin:</span>
                      <span class="detail-value">{{ formatHora(jornada.hora_fin) }}</span>
                    </div>
                  </div>
                  
                  <div class="detail-group">
                    <div class="detail-item">
                      <i class="fas fa-coffee text-warning"></i>
                      <span class="detail-label">Descanso:</span>
                      <span class="detail-value">{{ formatTiempoDescanso(jornada.tiempo_descanso) }}</span>
                    </div>
                    <div class="detail-item">
                      <i class="fas fa-clock text-primary"></i>
                      <span class="detail-label">Total:</span>
                      <span class="detail-value">{{ formatHorasDecimales(jornada.total_horas) }}</span>
                    </div>
                  </div>
                </div>

                <div class="hours-breakdown">
                  <div class="hours-item regular">
                    <div class="hours-icon">
                      <i class="fas fa-business-time"></i>
                    </div>
                    <div class="hours-info">
                      <span class="hours-label">Horas Regulares</span>
                      <span class="hours-value">{{ formatHorasDecimales(jornada.horas_regulares) }}</span>
                    </div>
                  </div>

                  <div class="hours-item extra" *ngIf="jornada.horas_extras > 0">
                    <div class="hours-icon">
                      <i class="fas fa-clock"></i>
                    </div>
                    <div class="hours-info">
                      <span class="hours-label">Horas Extras</span>
                      <span class="hours-value">{{ formatHorasDecimales(jornada.horas_extras) }}</span>
                    </div>
                  </div>

                  <div class="hours-item holiday" *ngIf="jornada.es_feriado">
                    <div class="hours-icon">
                      <i class="fas fa-star"></i>
                    </div>
                    <div class="hours-info">
                      <span class="hours-label">D칤a Feriado</span>
                      <span class="hours-value">S칤</span>
                    </div>
                  </div>
                </div>

                <div *ngIf="jornada.notas_inicio || jornada.notas_fin" class="jornada-notes">
                  <div *ngIf="jornada.notas_inicio" class="note-item">
                    <strong>Notas de inicio:</strong> {{ jornada.notas_inicio }}
                  </div>
                  <div *ngIf="jornada.notas_fin" class="note-item">
                    <strong>Notas de fin:</strong> {{ jornada.notas_fin }}
                  </div>
                </div>
              </div>
            </div>

            <!-- MODO EDICI칍N -->
            <div *ngIf="isEditingJornada(jornada.id)" class="jornada-edit-mode">
              <form [formGroup]="jornadaEditForm" class="jornada-edit-form">
                <div class="form-row">
                  <div class="form-group col-md-4">
                    <label for="edit-fecha-{{jornada.id}}">Fecha</label>
                    <input type="date" id="edit-fecha-{{jornada.id}}" formControlName="fecha" class="form-control">
                  </div>
                  <div class="form-group col-md-4">
                    <label for="edit-hora-inicio-{{jornada.id}}">Hora Inicio</label>
                    <input type="time" id="edit-hora-inicio-{{jornada.id}}" formControlName="hora_inicio" class="form-control">
                  </div>
                  <div class="form-group col-md-4">
                    <label for="edit-hora-fin-{{jornada.id}}">Hora Fin</label>
                    <input type="time" id="edit-hora-fin-{{jornada.id}}" formControlName="hora_fin" class="form-control">
                  </div>
                </div>

                <div class="form-row">
                  <div class="form-group col-md-4">
                    <label for="edit-descanso-{{jornada.id}}">Descanso (minutos)</label>
                    <input type="number" id="edit-descanso-{{jornada.id}}" formControlName="tiempo_descanso" class="form-control" min="0">
                  </div>
                  <div class="form-group col-md-4">
                    <label for="edit-estado-{{jornada.id}}">Estado</label>
                    <select id="edit-estado-{{jornada.id}}" formControlName="estado" class="form-control">
                      <option value="activa">Activa</option>
                      <option value="pausada">Pausada</option>
                      <option value="completada">Completada</option>
                      <option value="cancelada">Cancelada</option>
                    </select>
                  </div>
                  <div class="form-group col-md-4">
                    <label class="checkbox-label">
                      <input type="checkbox" formControlName="es_feriado">
                      Es Feriado
                    </label>
                  </div>
                </div>

                <div class="form-row">
                  <div class="form-group col-md-6">
                    <label for="edit-notas-inicio-{{jornada.id}}">Notas de Inicio</label>
                    <textarea id="edit-notas-inicio-{{jornada.id}}" formControlName="notas_inicio" class="form-control" rows="2"></textarea>
                  </div>
                  <div class="form-group col-md-6">
                    <label for="edit-notas-fin-{{jornada.id}}">Notas de Fin</label>
                    <textarea id="edit-notas-fin-{{jornada.id}}" formControlName="notas_fin" class="form-control" rows="2"></textarea>
                  </div>
                </div>

                <div class="edit-actions">
                  <button type="button" class="btn btn-secondary" (click)="cancelEditJornada()" [disabled]="savingJornada">
                    <i class="fas fa-times"></i> Cancelar
                  </button>
                  <button type="button" class="btn btn-primary" (click)="saveJornada(jornada.id)" [disabled]="jornadaEditForm.invalid || savingJornada">
                    <i class="fas" [ngClass]="savingJornada ? 'fa-spinner fa-spin' : 'fa-save'"></i>
                    {{ savingJornada ? 'Guardando...' : 'Guardar Cambios' }}
                  </button>
                </div>
              </form>
            </div>

          </div>
        </div>
      </div>
    </div>

    <div class="modal-footer">
      <button type="button" class="btn btn-secondary" (click)="closeModals()">Cerrar</button>
    </div>
  </div>
</div>

<!-- Modal de Confirmaci칩n de Eliminaci칩n de Jornada -->
<div class="modal-overlay" [class.active]="isDeleteJornadaModalOpen">
  <div class="modal-card">
    <div class="modal-header">
      <h2>Confirmar Eliminaci칩n de Jornada</h2>
      <button class="modal-close" (click)="closeDeleteJornadaModal()">&times;</button>
    </div>
    <div class="modal-body">
      <p><strong>쮼st치s seguro de que deseas eliminar esta jornada laboral?</strong></p>
      <div *ngIf="jornadaToDelete" class="delete-jornada-info">
        <p><i class="fas fa-calendar-alt"></i> <strong>Fecha:</strong> {{ formatFecha(jornadaToDelete.fecha) }}</p>
        <p><i class="fas fa-clock"></i> <strong>Horario:</strong> {{ formatHora(jornadaToDelete.hora_inicio) }} - {{ formatHora(jornadaToDelete.hora_fin) }}</p>
        <p><i class="fas fa-business-time"></i> <strong>Total horas:</strong> {{ formatHorasDecimales(jornadaToDelete.total_horas) }}</p>
      </div>
      <p class="text-danger"><i class="fas fa-exclamation-triangle"></i> Esta acci칩n no se puede deshacer.</p>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn btn-secondary" (click)="closeDeleteJornadaModal()" [disabled]="deletingJornada">
        Cancelar
      </button>
      <button type="button" class="btn btn-danger" (click)="confirmDeleteJornada()" [disabled]="deletingJornada">
        <i class="fas" [ngClass]="deletingJornada ? 'fa-spinner fa-spin' : 'fa-trash'"></i>
        {{ deletingJornada ? 'Eliminando...' : 'Eliminar Jornada' }}
      </button>
    </div>
  </div>
</div>

<!-- Modal de Creaci칩n de Nueva Jornada -->
<div class="modal-overlay" [class.active]="isCreateJornadaModalOpen">
  <div class="modal-card modal-card-large">
    <div class="modal-header">
      <h2><i class="fas fa-plus-circle"></i> Nueva Jornada Laboral - {{ selectedUser?.nombre }}</h2>
      <button class="modal-close" (click)="closeCreateJornadaModal()">&times;</button>
    </div>
    <div class="modal-body">
      <form [formGroup]="jornadaCreateForm" class="jornada-create-form">
        <div class="form-row">
          <div class="form-group col-md-4">
            <label for="create-fecha"><i class="fas fa-calendar-alt"></i> Fecha *</label>
            <input type="date" id="create-fecha" formControlName="fecha" class="form-control">
          </div>
          <div class="form-group col-md-4">
            <label for="create-hora-inicio"><i class="fas fa-play-circle"></i> Hora Inicio *</label>
            <input type="time" id="create-hora-inicio" formControlName="hora_inicio" class="form-control">
          </div>
          <div class="form-group col-md-4">
            <label for="create-hora-fin"><i class="fas fa-stop-circle"></i> Hora Fin</label>
            <input type="time" id="create-hora-fin" formControlName="hora_fin" class="form-control">
          </div>
        </div>

        <div class="form-row">
          <div class="form-group col-md-4">
            <label for="create-descanso"><i class="fas fa-coffee"></i> Descanso (minutos) *</label>
            <input type="number" id="create-descanso" formControlName="tiempo_descanso" class="form-control" min="0" placeholder="0">
          </div>
          <div class="form-group col-md-4">
            <label for="create-estado"><i class="fas fa-info-circle"></i> Estado *</label>
            <select id="create-estado" formControlName="estado" class="form-control">
              <option value="activa">Activa</option>
              <option value="pausada">Pausada</option>
              <option value="completada">Completada</option>
              <option value="cancelada">Cancelada</option>
            </select>
          </div>
          <div class="form-group col-md-4">
            <label class="checkbox-label" style="margin-top: 30px;">
              <input type="checkbox" formControlName="es_feriado">
              <i class="fas fa-star"></i> Es Feriado
            </label>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group col-md-6">
            <label for="create-notas-inicio"><i class="fas fa-sticky-note"></i> Notas de Inicio</label>
            <textarea id="create-notas-inicio" formControlName="notas_inicio" class="form-control" rows="3" placeholder="Ingrese notas opcionales al inicio de la jornada"></textarea>
          </div>
          <div class="form-group col-md-6">
            <label for="create-notas-fin"><i class="fas fa-sticky-note"></i> Notas de Fin</label>
            <textarea id="create-notas-fin" formControlName="notas_fin" class="form-control" rows="3" placeholder="Ingrese notas opcionales al finalizar la jornada"></textarea>
          </div>
        </div>

        <div class="alert alert-info">
          <i class="fas fa-info-circle"></i> Los campos marcados con * son obligatorios.
        </div>
      </form>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn btn-secondary" (click)="closeCreateJornadaModal()" [disabled]="savingNewJornada">
        <i class="fas fa-times"></i> Cancelar
      </button>
      <button type="button" class="btn btn-success" (click)="saveNewJornada()" [disabled]="jornadaCreateForm.invalid || savingNewJornada">
        <i class="fas" [ngClass]="savingNewJornada ? 'fa-spinner fa-spin' : 'fa-save'"></i>
        {{ savingNewJornada ? 'Guardando...' : 'Crear Jornada' }}
      </button>
    </div>
  </div>
</div>