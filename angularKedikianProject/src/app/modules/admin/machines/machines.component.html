<div class="maquinaria-container">
  <div class="header">
    <h2>Administración de Maquinaria</h2>
    <button class="btn-add" (click)="abrirModalAgregar()">
      <i class="fas fa-plus"></i> Agregar Máquina
    </button>
  </div>

  <div class="search-bar">
    <input type="text" placeholder="Buscar máquina..." [(ngModel)]="terminoBusqueda" (input)="filtrarMaquinas()">
    <div class="filtros">
      <label>
        <input type="checkbox" [(ngModel)]="mostrarSoloActivas" (change)="filtrarMaquinas()">
        Solo activas
      </label>
    </div>
  </div>

  <div class="table-container" *ngIf="maquinasFiltradas.length > 0; else noData">
    <table>
      <thead>
        <tr>
          <th>Codigo</th>
          <th>Nombre</th>
          <th>Proyecto</th>
          <th>Estado</th>
          <th>Horas de Uso</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let maquina of maquinasFiltradas">          <td>{{maquina.codigo}}</td>
          <td>{{maquina.nombre}}</td>
          <td>
            <div class="proyectos-lista">
              <span *ngIf="!maquina.proyectos?.length" class="sin-proyectos">Sin proyectos asignados</span>
              <div *ngFor="let proyecto of maquina.proyectos" class="proyecto-item">
                <span class="proyecto-nombre">{{proyecto.nombre}}</span>
                <span class="fecha-asignacion">{{proyecto.fechaAsignacion | date:'dd/MM/yyyy'}}</span>
              </div>
            </div>
          </td>
          <td>
            <span class="estado" [ngClass]="{'activo': maquina.estado, 'inactivo': !maquina.estado}">
              {{maquina.estado ? 'Activo' : 'Inactivo'}}
            </span>
          </td>
          <td>{{maquina.horas_uso}} horas</td>
          <td class="acciones">
            <button class="btn-editar" (click)="abrirModalEditar(maquina)">
              <i class="fas fa-edit"></i>
            </button>
            <button class="btn-eliminar" (click)="eliminarMaquina(+maquina.codigo)">
              <i class="fas fa-trash"></i>
            </button>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <ng-template #noData>
    <div class="no-data">
      <p>No hay máquinas disponibles</p>
    </div>
  </ng-template>
</div>

<!-- Modal para agregar/editar máquina -->
<div class="modal" *ngIf="modalVisible">
  <div class="modal-content">
    <div class="modal-header">
      <h3>{{modoEdicion ? 'Editar Máquina' : 'Agregar Máquina'}}</h3>
      <button class="btn-cerrar" (click)="cerrarModal()">×</button>
    </div>
    <div class="modal-body">
      <form [formGroup]="maquinaForm" (ngSubmit)="guardarMaquina()">
        <div class="form-group">
          <label for="nombre">Nombre:</label>
          <input type="text" id="nombre" formControlName="nombre" placeholder="Nombre de la máquina">
          <div class="error-message" *ngIf="maquinaForm.get('nombre')?.invalid && maquinaForm.get('nombre')?.touched">
            El nombre es obligatorio
          </div>
        </div>

        <div class="form-group">
          <label for="estado">Estado:</label>
          <select id="estado" formControlName="estado">
            <option [ngValue]="true">Activo</option>
            <option [ngValue]="false">Inactivo</option>
          </select>
        </div>

        <div class="form-group">
          <label for="horas_uso">Horas de uso:</label>
          <input type="number" id="horas_uso" formControlName="horas_uso" min="0">
          <div class="error-message"
            *ngIf="maquinaForm.get('horas_uso')?.invalid && maquinaForm.get('horas_uso')?.touched">
            Las horas deben ser un número válido mayor o igual a 0
          </div>
        </div>

        <div class="form-actions">
          <button type="button" class="btn-cancelar" (click)="cerrarModal()">Cancelar</button>
          <button type="submit" class="btn-guardar" [disabled]="maquinaForm.invalid">Guardar</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal de confirmación de eliminación (ahora separado y a nivel de documento) -->
<div class="modal" *ngIf="modalConfirmacionVisible">
  <div class="modal-content modal-confirmacion">
    <div class="modal-header">
      <h3>Confirmar eliminación</h3>
      <button class="btn-cerrar" (click)="cancelarEliminarMaquina()">×</button>
    </div>
    <div class="modal-body">
      <p>¿Está seguro que desea eliminar esta máquina?</p>
      <p>Esta acción no se puede deshacer.</p>

      <div class="form-actions">
        <button type="button" class="btn-cancelar" (click)="cancelarEliminarMaquina()">Cancelar</button>
        <button type="button" class="btn-eliminar-confirmar" (click)="confirmarEliminarMaquina()">Eliminar</button>
      </div>
    </div>
  </div>
</div>
