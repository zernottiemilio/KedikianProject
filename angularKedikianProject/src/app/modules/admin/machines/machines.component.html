<div class="maquinaria-container">
  <div class="header">
    <h2>Administración de Maquinaria</h2>
    <button class="btn-add" (click)="abrirModalAgregar()">
      <i class="fas fa-plus"></i> Agregar Máquina
    </button>
  </div>

  <div class="search-bar">
    <input type="text" placeholder="Buscar máquina..." [(ngModel)]="terminoBusqueda" (input)="filtrarMaquinas()">
    <div class="filtros">
      <label>
        <input type="checkbox" [(ngModel)]="mostrarSoloActivas" (change)="filtrarMaquinas()">
        Solo activas
      </label>
    </div>
  </div>

  <div class="table-container" *ngIf="maquinasFiltradas.length > 0; else noData">
    <table>
      <thead>
        <tr>
          <th>Codigo</th>
          <th>Nombre</th>
          <th>Proyecto</th>
          <th>Estado</th>
          <th>Horas de Uso</th>
          <th>Mantenimiento</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let maquina of maquinasFiltradas">
          <td>{{maquina.codigo}}</td>
          <td>{{maquina.nombre}}</td>
          <td>
            {{ getNombreProyecto(maquina.proyecto_id) }}
          </td>
          <td>
            <span class="estado" [ngClass]="{'activo': maquina.estado, 'inactivo': !maquina.estado}">
              {{maquina.estado ? 'Activo' : 'Inactivo'}}
            </span>
          </td>
          <td>{{maquina.horas_uso}} horas</td>
          <td>
            <div [ngClass]="getMantenimientoClass(maquina)" class="badge-mant">
              {{ getMantenimientoTexto(maquina) }}
            </div>
          </td>
          <td class="acciones">
            <button class="btn-mant btn-mant-registrar" title="Registrar mantenimiento" (click)="abrirModalRegistrarMantenimiento(maquina)">
              <i class="fas fa-wrench"></i>
            </button>
            <button class="btn-mant btn-mant-historial" title="Ver historial mantenimiento" (click)="abrirModalHistorial(maquina)">
              <i class="fas fa-history"></i>
            </button>
            <button class="btn-mant" title="Agregar horas en proyecto" (click)="abrirModalAgregarHoras(maquina)">
              <i class="fas fa-clock"></i>
            </button>
            <button class="btn-mant btn-historial-horas" title="Ver historial de horas" (click)="abrirModalHistorialHoras(maquina)">
              <i class="fas fa-chart-bar"></i>
            </button>
            <button class="btn-editar" (click)="abrirModalEditar(maquina)">
              <i class="fas fa-edit"></i>
            </button>
            <button class="btn-eliminar" (click)="eliminarMaquina(maquina.id)">
              <i class="fas fa-trash"></i>
            </button>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <ng-template #noData>
    <div class="no-data">
      <p>No hay máquinas disponibles</p>
    </div>
  </ng-template>
</div>

<!-- Modal para agregar/editar máquina -->
<div class="modal" *ngIf="modalVisible">
  <div class="modal-content">
    <div class="modal-header">
      <h3>{{modoEdicion ? 'Editar Máquina' : 'Agregar Máquina'}}</h3>
      <button class="btn-cerrar" (click)="cerrarModal()">×</button>
    </div>
    <div class="modal-body">
      <form [formGroup]="maquinaForm" (ngSubmit)="guardarMaquina()">
        <div class="form-group">
          <label for="nombre">Nombre:</label>
          <input type="text" id="nombre" formControlName="nombre" placeholder="Nombre de la máquina">
          <div class="error-message" *ngIf="maquinaForm.get('nombre')?.invalid && maquinaForm.get('nombre')?.touched">
            El nombre es obligatorio
          </div>
        </div>

        <div class="form-group">
          <label for="estado">Estado:</label>
          <select id="estado" formControlName="estado">
            <option [ngValue]="true">Activo</option>
            <option [ngValue]="false">Inactivo</option>
          </select>
        </div>

        <div class="form-group">
          <label for="horas_uso">Horas de uso:</label>
          <input type="number" id="horas_uso" formControlName="horas_uso" min="0">
          <div class="error-message"
            *ngIf="maquinaForm.get('horas_uso')?.invalid && maquinaForm.get('horas_uso')?.touched">
            Las horas deben ser un número válido mayor o igual a 0
          </div>
        </div>

        <div class="form-group">
          <label for="proyecto_id">Proyecto asignado:</label>
          <select id="proyecto_id" formControlName="proyecto_id">
            <option [ngValue]="null">Sin proyecto</option>
            <option *ngFor="let proyecto of proyectos" [ngValue]="proyecto.id">{{ proyecto.nombre }}</option>
          </select>
        </div>

        <div class="form-actions">
          <button type="button" class="btn-cancelar" (click)="cerrarModal()">Cancelar</button>
          <button type="submit" class="btn-guardar" [disabled]="maquinaForm.invalid">Guardar</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal de confirmación de eliminación -->
<div class="modal" *ngIf="modalConfirmacionVisible">
  <div class="modal-content modal-confirmacion">
    <div class="modal-header">
      <h3>Confirmar eliminación</h3>
      <button class="btn-cerrar" (click)="cancelarEliminarMaquina()">×</button>
    </div>
    <div class="modal-body">
      <p>¿Está seguro que desea eliminar esta máquina?</p>
      <p>Esta acción no se puede deshacer.</p>

      <div class="form-actions">
        <button type="button" class="btn-cancelar" (click)="cancelarEliminarMaquina()">Cancelar</button>
        <button type="button" class="btn-eliminar-confirmar" (click)="confirmarEliminarMaquina()">Eliminar</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal Registrar Mantenimiento -->
<div class="modal" *ngIf="modalMantVisible">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Registrar mantenimiento</h3>
      <button class="btn-cerrar" (click)="cerrarModalMantenimiento()">×</button>
    </div>
    <div class="modal-body">
      <form [formGroup]="mantenimientoForm" (ngSubmit)="confirmarRegistrarMantenimiento()">
        <div class="form-group">
          <label>Máquina</label>
          <div>{{ maquinaSeleccionada?.nombre }} ({{ maquinaSeleccionada?.horas_uso }} hs)</div>
        </div>
        <div class="form-group">
          <label for="fecha_mant">Fecha</label>
          <input id="fecha_mant" type="date" formControlName="fecha">
        </div>
        <div class="form-group">
          <label for="tipo_mant">Tipo de mantenimiento</label>
          <select id="tipo_mant" formControlName="tipo">
            <option value="preventivo">Preventivo</option>
            <option value="urgencia">Urgencia</option>
            <option value="Tiempo Cumplido">Tiempo Cumplido</option>
          </select>
          <div class="error-message" *ngIf="mantenimientoForm?.get('tipo')?.invalid && mantenimientoForm?.get('tipo')?.touched">
            Seleccione un tipo de mantenimiento
          </div>
        </div>
        <div class="form-group">
          <label for="desc_mant">Descripción</label>
          <textarea id="desc_mant" rows="3" formControlName="descripcion" placeholder="Descripción del mantenimiento"></textarea>
          <div class="error-message" *ngIf="mantenimientoForm?.get('descripcion')?.invalid && mantenimientoForm?.get('descripcion')?.touched">
            Ingrese una descripción válida (mínimo 3 caracteres)
          </div>
        </div>
        <div class="form-actions">
          <button type="button" class="btn-cancelar" (click)="cerrarModalMantenimiento()">Cancelar</button>
          <button type="submit" class="btn-guardar" [disabled]="mantenimientoForm.invalid">Registrar</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal Historial de Mantenimiento -->
<div class="modal" *ngIf="modalHistorialVisible">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Historial de mantenimiento</h3>
      <button class="btn-cerrar" (click)="cerrarModalHistorial()">×</button>
    </div>
    <div class="modal-body">
      <div *ngIf="maquinaSeleccionada as maq">
        <div class="hist-resumen">
          <strong>Máquina:</strong> {{ maq.nombre }}
        </div>
      </div>
      <div *ngIf="historialPorMaquina[maquinaSeleccionada?.id || 0]?.length; else noMant">
        <table>
          <thead>
            <tr>
              <th>Fecha</th>
              <th>Horas máquina</th>
              <th>Tipo</th>
              <th>Descripción</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let item of historialPorMaquina[maquinaSeleccionada?.id || 0]">
              <td>{{ formatearFecha(item.fecha_mantenimiento) }}</td>
              <td>{{ item.horas_maquina ?? '-' }}</td>
              <td>{{ item.tipo_mantenimiento }}</td>
              <td>{{ item.descripcion }}</td>
              <td>
                <button class="btn-eliminar-mant" title="Eliminar mantenimiento" (click)="eliminarMantenimiento(item.id)">
                  <i class="fas fa-trash"></i>
                </button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
      <ng-template #noMant>
        <div class="no-data">
          <p>Sin mantenimientos registrados.</p>
        </div>
      </ng-template>
    </div>
  </div>
</div>

<!-- Modal Agregar Horas en Proyecto -->
<div class="modal" *ngIf="modalHorasVisible">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Agregar horas en proyecto</h3>
      <button class="btn-cerrar" (click)="cerrarModalHoras()">×</button>
    </div>
    <div class="modal-body">
      <form [formGroup]="horasForm" (ngSubmit)="confirmarAgregarHoras()">
        <div class="form-group">
          <label>Máquina</label>
          <div>{{ maquinaSeleccionada?.nombre }} ({{ maquinaSeleccionada?.horas_uso }} hs totales)</div>
        </div>
        <div class="form-group">
          <label for="proyecto_horas">Proyecto</label>
          <select id="proyecto_horas" formControlName="proyecto_id">
            <option [ngValue]="null">Seleccione un proyecto</option>
            <option *ngFor="let proyecto of proyectos" [ngValue]="proyecto.id">{{ proyecto.nombre }}</option>
          </select>
          <div class="error-message" *ngIf="horasForm?.get('proyecto_id')?.invalid && horasForm?.get('proyecto_id')?.touched">
            Seleccione un proyecto
          </div>
        </div>
        <div class="form-group">
          <label for="horas_trabajadas">Horas trabajadas</label>
          <input id="horas_trabajadas" type="number" formControlName="horas" min="0" step="0.5">
          <div class="error-message" *ngIf="horasForm?.get('horas')?.invalid && horasForm?.get('horas')?.touched">
            Ingrese una cantidad válida de horas (mayor a 0)
          </div>
        </div>
        <div class="form-group">
          <label for="fecha_trabajo">Fecha</label>
          <input id="fecha_trabajo" type="date" formControlName="fecha">
          <div class="error-message" *ngIf="horasForm?.get('fecha')?.invalid && horasForm?.get('fecha')?.touched">
            Ingrese una fecha válida
          </div>
        </div>
        <div class="form-actions">
          <button type="button" class="btn-cancelar" (click)="cerrarModalHoras()">Cancelar</button>
          <button type="submit" class="btn-guardar" [disabled]="horasForm.invalid">Guardar</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal Historial de Horas - CORREGIDO -->
<div class="modal" *ngIf="modalHistorialHorasVisible">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Historial de Horas Trabajadas</h3>
      <button class="btn-cerrar" (click)="cerrarModalHistorialHoras()">×</button>
    </div>
    <div class="modal-body">
      <!-- Información de la máquina -->
      <div *ngIf="maquinaSeleccionada as maq">
        <div class="hist-resumen">
          <strong>Máquina:</strong> {{ maq.nombre }} (Código: {{ maq.codigo }})
          <br>
          <strong>Total horas registradas:</strong> {{ totalHorasHistorial }} hs
        </div>
      </div>

      <!-- Filtros (opcional) -->
      <div class="filtros-historial" *ngIf="proyectosFiltroHistorial.length > 0">
        <div class="form-group">
          <label for="filtroProyecto">Filtrar por proyecto:</label>
          <select id="filtroProyecto" [(ngModel)]="filtroProyectoHistorial" (change)="aplicarFiltrosHistorial()">
            <option [ngValue]="null">Todos los proyectos</option>
            <option *ngFor="let proyecto of proyectosFiltroHistorial" [ngValue]="proyecto.id">
              {{ proyecto.nombre }}
            </option>
          </select>
        </div>

        <div class="form-group">
          <label for="fechaInicio">Desde:</label>
          <input id="fechaInicio" type="date" [(ngModel)]="fechaInicioFiltro" (change)="aplicarFiltrosHistorial()">
        </div>

        <div class="form-group">
          <label for="fechaFin">Hasta:</label>
          <input id="fechaFin" type="date" [(ngModel)]="fechaFinFiltro" (change)="aplicarFiltrosHistorial()">
        </div>

        <button class="btn-limpiar" (click)="limpiarFiltrosHistorial()">Limpiar filtros</button>
      </div>

      <!-- Tabla con datos filtrados -->
      <div *ngIf="historialHorasFiltrado.length > 0; else noHoras">
        <table>
          <thead>
            <tr>
              <th>Fecha</th>
              <th>Proyecto</th>
              <th>Horas trabajadas</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let registro of historialHorasFiltrado">
              <td>{{ formatearFecha(registro.fecha) }}</td>
              <td>{{ registro.nombre_proyecto || getNombreProyecto(registro.proyecto_id) }}</td>
              <td>{{ registro.horas_trabajadas }} hs</td>
            </tr>
          </tbody>
        </table>

        <!-- Opción de exportar (opcional) -->
        <div class="export-section">
          <button class="btn-export" (click)="exportarHistorialCSV()">
            <i class="fas fa-download"></i> Exportar CSV
          </button>
        </div>
      </div>

      <ng-template #noHoras>
        <div class="no-data">
          <p>Sin registros de horas trabajadas para esta máquina.</p>
        </div>
      </ng-template>
    </div>
  </div>
</div>
