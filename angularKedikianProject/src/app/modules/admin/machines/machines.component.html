<div class="maquinaria-container">
  <div class="header">
    <h2>Administración de Maquinaria</h2>
    <button class="btn-add" (click)="abrirModalAgregar()">
      <i class="fas fa-plus"></i> Agregar Máquina
    </button>
  </div>

  <div class="search-bar">
    <input type="text" placeholder="Buscar máquina..." [(ngModel)]="terminoBusqueda" (input)="filtrarMaquinas()">
    <div class="filtros">
      <label>
        <input type="checkbox" [(ngModel)]="mostrarSoloActivas" (change)="filtrarMaquinas()">
        Solo activas
      </label>
    </div>
  </div>

  <div class="table-container" *ngIf="maquinasFiltradas.length > 0; else noData">
    <table>
      <thead>
        <tr>
          <th>Nombre</th>
          <th>Estado</th>
          <th>Horas de Uso</th>
          <th>Próximo Mant.</th>
          <th>Horas Restantes</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let maquina of maquinasFiltradas">
          <td>{{maquina.nombre}}</td>
          <td>
            <span class="estado" [ngClass]="{'activo': maquina.estado, 'inactivo': !maquina.estado}">
              {{maquina.estado ? 'Activo' : 'Inactivo'}}
            </span>
          </td>
          <td>{{maquina.horas_uso}} hs</td>
          <td>{{getProximoMantenimiento(maquina)}} hs</td>
          <td>
            <span [ngClass]="getColorHorasRestantes(maquina)" [title]="getEstadoMantenimiento(maquina)">
              <strong>{{getHorasRestantes(maquina)}} hs</strong>
            </span>
          </td>
          <td class="acciones">
            <button class="btn-mant btn-mant-registrar" title="Registrar mantenimiento" (click)="abrirModalRegistrarMantenimiento(maquina)">
              <i class="fas fa-wrench"></i>
            </button>
            <button class="btn-mant btn-mant-historial" title="Ver historial mantenimiento" (click)="abrirModalHistorial(maquina)">
              <i class="fas fa-history"></i>
            </button>
            <button class="btn-editar" (click)="abrirModalEditar(maquina)">
              <i class="fas fa-edit"></i>
            </button>
            <button class="btn-eliminar" (click)="eliminarMaquina(maquina.id)">
              <i class="fas fa-trash"></i>
            </button>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <ng-template #noData>
    <div class="no-data">
      <p>No hay máquinas disponibles</p>
    </div>
  </ng-template>
</div>

<!-- Modal para agregar/editar máquina -->
<div class="modal" *ngIf="modalVisible">
  <div class="modal-content">
    <div class="modal-header">
      <h3>{{modoEdicion ? 'Editar Máquina' : 'Agregar Máquina'}}</h3>
      <button class="btn-cerrar" (click)="cerrarModal()">×</button>
    </div>
    <div class="modal-body">
      <form [formGroup]="maquinaForm" (ngSubmit)="guardarMaquina()">
        <div class="form-group">
          <label for="nombre">Nombre:</label>
          <input type="text" id="nombre" formControlName="nombre" placeholder="Nombre de la máquina">
          <div class="error-message" *ngIf="maquinaForm.get('nombre')?.invalid && maquinaForm.get('nombre')?.touched">
            El nombre es obligatorio
          </div>
        </div>

        <div class="form-group">
          <label for="estado">Estado:</label>
          <select id="estado" formControlName="estado">
            <option [ngValue]="true">Activo</option>
            <option [ngValue]="false">Inactivo</option>
          </select>
        </div>

        <div class="form-group">
          <label for="horas_uso">Horas de uso:</label>
          <input type="number" id="horas_uso" formControlName="horas_uso" min="0">
          <div class="error-message"
            *ngIf="maquinaForm.get('horas_uso')?.invalid && maquinaForm.get('horas_uso')?.touched">
            Las horas deben ser un número válido mayor o igual a 0
          </div>
        </div>

        <div class="form-actions">
          <button type="button" class="btn-cancelar" (click)="cerrarModal()">Cancelar</button>
          <button type="submit" class="btn-guardar" [disabled]="maquinaForm.invalid">Guardar</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal para agregar horas -->
<div class="modal" *ngIf="modalHorasVisible">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Agregar Horas - {{maquinaSeleccionada?.nombre}}</h3>
      <button class="btn-cerrar" (click)="cerrarModalHoras()">×</button>
    </div>
    <div class="modal-body">
      <form [formGroup]="horasForm" (ngSubmit)="confirmarAgregarHoras()">
        <div class="form-group">
          <label for="horas">Horas trabajadas:</label>
          <input type="number" id="horas" formControlName="horas" min="0.1" step="0.1" placeholder="Ej: 8.5">
          <div class="error-message" *ngIf="horasForm.get('horas')?.invalid && horasForm.get('horas')?.touched">
            Ingrese un número válido de horas
          </div>
        </div>

        <div class="form-group">
          <label for="fecha">Fecha:</label>
          <input type="date" id="fecha" formControlName="fecha">
          <div class="error-message" *ngIf="horasForm.get('fecha')?.invalid && horasForm.get('fecha')?.touched">
            La fecha es obligatoria
          </div>
        </div>

        <div class="form-group">
          <label for="descripcion">Descripción (opcional):</label>
          <input type="text" id="descripcion" formControlName="descripcion" placeholder="Trabajo realizado...">
        </div>

        <div class="form-actions">
          <button type="button" class="btn-cancelar" (click)="cerrarModalHoras()">Cancelar</button>
          <button type="submit" class="btn-guardar" [disabled]="horasForm.invalid">Agregar Horas</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal para registrar mantenimiento -->
<div class="modal" *ngIf="modalMantVisible">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Registrar Mantenimiento - {{maquinaSeleccionada?.nombre}}</h3>
      <button class="btn-cerrar" (click)="cerrarModalMantenimiento()">×</button>
    </div>
    <div class="modal-body">
      <form [formGroup]="mantenimientoForm" (ngSubmit)="confirmarRegistrarMantenimiento()">
        <div class="form-group">
          <label for="fecha">Fecha:</label>
          <input type="date" id="fecha" formControlName="fecha">
          <div class="error-message" *ngIf="mantenimientoForm.get('fecha')?.invalid && mantenimientoForm.get('fecha')?.touched">
            La fecha es obligatoria
          </div>
        </div>

        <div class="form-group">
          <label for="tipo">Tipo de mantenimiento:</label>
          <select id="tipo" formControlName="tipo">
            <option value="preventivo">Preventivo</option>
            <option value="correctivo">Tiempo Cumplido</option>
            <option value="predictivo">Urgencia</option>
          </select>
        </div>

        <div class="form-group">
          <label for="descripcion">Descripción:</label>
          <textarea id="descripcion" formControlName="descripcion" rows="3" placeholder="Descripción del mantenimiento realizado..."></textarea>
          <div class="error-message" *ngIf="mantenimientoForm.get('descripcion')?.invalid && mantenimientoForm.get('descripcion')?.touched">
            La descripción es obligatoria (mínimo 3 caracteres)
          </div>
        </div>

        <div class="form-actions">
          <button type="button" class="btn-cancelar" (click)="cerrarModalMantenimiento()">Cancelar</button>
          <button type="submit" class="btn-guardar" [disabled]="mantenimientoForm.invalid">Registrar</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal historial de mantenimiento -->
<div class="modal" *ngIf="modalHistorialVisible">
  <div class="modal-content modal-large">
    <div class="modal-header">
      <h3>Historial de Mantenimiento - {{maquinaSeleccionada?.nombre}}</h3>
      <button class="btn-cerrar" (click)="cerrarModalHistorial()">×</button>
    </div>
    <div class="modal-body">
      <table *ngIf="getHistorialMaquina(maquinaSeleccionada?.id || 0).length > 0; else noHistorial">
        <thead>
          <tr>
            <th>Fecha</th>
            <th>Horas Máquina</th>
            <th>Tipo</th>
            <th>Descripción</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let mantenimiento of getHistorialMaquina(maquinaSeleccionada?.id || 0)">
            <td>{{ formatearFecha(mantenimiento.fecha_mantenimiento) }}</td>
            <td>{{ mantenimiento.horas_maquina }} hs</td>
            <td>{{ mantenimiento.tipo_mantenimiento | titlecase }}</td>
            <td>{{ mantenimiento.descripcion }}</td>
            <td class="acciones">
              <button class="btn-eliminar-mant" (click)="eliminarMantenimiento(mantenimiento.id)" title="Eliminar">
                <i class="fas fa-trash"></i>
              </button>
            </td>
          </tr>
        </tbody>
      </table>
      
      <ng-template #noHistorial>
        <div class="no-data">
          <p>No hay registros de mantenimiento</p>
        </div>
      </ng-template>
    </div>
  </div>
</div>

<!-- Modal de confirmación de eliminación -->
<div class="modal" *ngIf="modalConfirmacionVisible">
  <div class="modal-content modal-confirmacion">
    <div class="modal-header">
      <h3>Confirmar eliminación</h3>
      <button class="btn-cerrar" (click)="cancelarEliminarMaquina()">×</button>
    </div>
    <div class="modal-body">
      <p>¿Está seguro que desea eliminar esta máquina?</p>
      <p>Esta acción no se puede deshacer.</p>

      <div class="form-actions">
        <button type="button" class="btn-cancelar" (click)="cancelarEliminarMaquina()">Cancelar</button>
        <button type="button" class="btn-eliminar-confirmar" (click)="confirmarEliminarMaquina()">Eliminar</button>
      </div>
    </div>
  </div>
</div>